<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Game of Five</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin_styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='users_styles.css') }}">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>‚öôÔ∏è Admin Panel</h2>
            </div>
            
            <nav class="sidebar-menu">
                <ul>
                    <li class="menu-item" data-section="dashboard">
                        <a href="#dashboard" class="menu-link">
                            <span class="icon">üìä</span>
                            <span class="label">Dashboard</span>
                        </a>
                    </li>
                    
                    <li class="menu-item active" data-section="users">
                        <a href="#users" class="menu-link">
                            <span class="icon">üë•</span>
                            <span class="label">Users</span>
                        </a>
                    </li>
                    
                    <li class="menu-item" data-section="agents">
                        <a href="#agents" class="menu-link">
                            <span class="icon">ü§ù</span>
                            <span class="label">Agents</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="#" class="menu-link menu-toggle" data-target="games-submenu">
                            <span class="icon">üéÆ</span>
                            <span class="label">Games</span>
                            <span class="arrow">‚ñº</span>
                        </a>
                        <ul class="submenu" id="games-submenu">
                            <li><a href="#games" data-game="silver">üê∏ Silver</a></li>
                            <li><a href="#games" data-game="gold">‚öΩ Gold</a></li>
                            <li><a href="#games" data-game="diamond">üèπ Diamond</a></li>
                            <li><a href="#games" data-game="platinum">ü™Ç Platinum</a></li>
                        </ul>
                    </li>
                    
                    <li class="menu-item" data-section="revenue">
                        <a href="#revenue" class="menu-link">
                            <span class="icon">üí∞</span>
                            <span class="label">Revenue</span>
                        </a>
                    </li>
                    
                    <li class="menu-item" data-section="tickets">
                        <a href="#tickets" class="menu-link">
                            <span class="icon">üé´</span>
                            <span class="label">Tickets</span>
                        </a>
                    </li>
                    
                    <li class="menu-item" data-section="settings">
                        <a href="#settings" class="menu-link">
                            <span class="icon">‚öôÔ∏è</span>
                            <span class="label">Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <a href="/logout" class="logout-btn">
                    <span class="icon">üö™</span>
                    <span>Logout</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1>User Management</h1>
                    <p id="header-subtitle">Manage and monitor all users</p>
                </div>
                <div class="header-right">
                    <div class="admin-info">
                        <span class="admin-username" id="admin-username">Admin</span>
                        <span class="admin-role">Administrator</span>
                    </div>
                </div>
            </header>

            <!-- Users Section -->
            <section id="users" class="section active">
                <div class="section-header">
                    <h2>All Users</h2>
                    <div class="section-controls">
                        <input type="text" id="search-users" class="search-input" placeholder="Search by username or ID...">
                        <button class="refresh-btn-table" id="refresh-users">üîÑ Refresh</button>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th class="col-sno">S.No</th>
                                <th class="col-userid">User ID</th>
                                <th class="col-referid">Refer ID</th>
                                <th class="col-joined">Date of Joining</th>
                                <th class="col-balance">Wallet Balance</th>
                                <th class="col-games">Games</th>
                                <th class="col-won">Won</th>
                                <th class="col-coinswon">Coins Won</th>
                                <th class="col-login">Login Details</th>
                                <th class="col-action">Block/UnBlock</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                    <div id="loading-indicator" class="loading">
                        <span>Loading users...</span>
                    </div>
                    <div id="no-users" class="no-data" style="display: none;">
                        <span>No users found</span>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <button id="prev-page" class="pagination-btn">‚Üê Previous</button>
                    <span id="page-info" class="page-info">Page 1</span>
                    <button id="next-page" class="pagination-btn">Next ‚Üí</button>
                </div>
            </section>

            <!-- Dashboard Section (Hidden) -->
            <section id="dashboard" class="section">
                <div class="section-header">
                    <h2>Dashboard Overview</h2>
                    <p>Real-time statistics and analytics</p>
                </div>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon users-icon">üë•</div>
                        <div class="stat-content">
                            <h3>Total Users</h3>
                            <p class="stat-value" id="total-users">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon active-icon">‚úÖ</div>
                        <div class="stat-content">
                            <h3>Active Users</h3>
                            <p class="stat-value" id="active-users">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon inactive-icon">‚ùå</div>
                        <div class="stat-content">
                            <h3>Inactive Users</h3>
                            <p class="stat-value" id="inactive-users">-</p>
                        </div>
                    </div>
                </div>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon revenue-icon">üíπ</div>
                        <div class="stat-content">
                            <h3>Total Revenue</h3>
                            <p class="stat-value" id="total-revenue">‚Çπ-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon deposit-icon">üìà</div>
                        <div class="stat-content">
                            <h3>Total Deposit</h3>
                            <p class="stat-value" id="total-deposit">‚Çπ-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon withdrawal-icon">üìâ</div>
                        <div class="stat-content">
                            <h3>Total Withdrawal</h3>
                            <p class="stat-value" id="total-withdrawal">‚Çπ-</p>
                        </div>
                    </div>
                </div>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon games-icon">üéÆ</div>
                        <div class="stat-content">
                            <h3>Games Played Today</h3>
                            <p class="stat-value" id="active-games">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon tickets-icon">üé´</div>
                        <div class="stat-content">
                            <h3>Active Tickets</h3>
                            <p class="stat-value" id="open-tickets">-</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blocked-icon">üö´</div>
                        <div class="stat-content">
                            <h3>Blocked Users</h3>
                            <p class="stat-value" id="blocked-users">-</p>
                        </div>
                    </div>
                </div>
                <div class="last-updated">
                    Last updated: <span id="last-update">Just now</span>
                    <button class="refresh-btn" id="refresh-stats">üîÑ Refresh</button>
                </div>
            </section>

            <!-- Other Sections -->
            <section id="agents" class="section">
                <div class="section-header">
                    <h2>Agents Management</h2>
                    <p>Manage affiliate agents</p>
                </div>
                <div class="content-placeholder">Agents management will be implemented next</div>
            </section>

            <section id="games" class="section">
                <div class="section-header">
                    <h2>Game Management</h2>
                    <p>Monitor active games and statistics</p>
                </div>
                <div class="content-placeholder">Games management will be implemented next</div>
            </section>

            <section id="revenue" class="section">
                <div class="section-header">
                    <h2>Revenue Analytics</h2>
                    <p>Detailed revenue and financial reports</p>
                </div>
                <div class="content-placeholder">Revenue analytics will be implemented next</div>
            </section>

            <section id="tickets" class="section">
                <div class="section-header">
                    <h2>Support Tickets</h2>
                    <p>Manage customer support tickets</p>
                </div>
                <div class="content-placeholder">Tickets management will be implemented next</div>
            </section>

            <section id="settings" class="section">
                <div class="section-header">
                    <h2>Settings</h2>
                    <p>System and admin settings</p>
                </div>
                <div class="content-placeholder">Settings will be implemented next</div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    
    <!-- Login Details Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Login Details</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="login-detail-row">
                    <label>User ID:</label>
                    <div class="login-detail-value" id="modal-userid">-</div>
                    <button class="copy-btn" onclick="copyToClipboard('#modal-userid')">üìã Copy</button>
                </div>
                <div class="login-detail-row">
                    <label>Username:</label>
                    <div class="login-detail-value" id="modal-username">-</div>
                    <button class="copy-btn" onclick="copyToClipboard('#modal-username')">üìã Copy</button>
                </div>
                <div class="login-detail-row">
                    <label>Password:</label>
                    <div class="login-detail-value password-field">
                        <input type="password" id="modal-password" readonly>
                        <button class="toggle-password-btn" onclick="togglePassword()">üëÅÔ∏è Show</button>
                        <button class="copy-btn" onclick="copyPassword()">üìã Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refer ID Modal -->
    <div id="refer-modal" class="modal">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>Referral Information</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="refer-info-row">
                    <label>Refer ID:</label>
                    <div class="refer-info-value" id="modal-referid">-</div>
                </div>
                <div class="refer-info-row">
                    <label>Agent Name:</label>
                    <div class="refer-info-value" id="modal-agentname">-</div>
                </div>
                <div class="refer-info-row">
                    <label>Referral Date:</label>
                    <div class="refer-info-value" id="modal-referdate">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Balance Modal -->
    <div id="wallet-modal" class="modal">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2>Wallet Details</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="wallet-info-row">
                    <label>Current Balance:</label>
                    <div class="wallet-info-value" id="modal-balance">‚Çπ-</div>
                </div>
                <div class="wallet-info-row">
                    <label>Total Earned:</label>
                    <div class="wallet-info-value" id="modal-earned">‚Çπ-</div>
                </div>
                <div class="wallet-info-row">
                    <label>Total Spent:</label>
                    <div class="wallet-info-value" id="modal-spent">‚Çπ-</div>
                </div>
                <div class="wallet-action-row">
                    <input type="number" id="amount-input" placeholder="Enter amount">
                    <button class="action-btn add-btn" onclick="creditAmount()">‚ûï Credit</button>
                    <button class="action-btn debit-btn" onclick="debitAmount()">‚ûñ Debit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Games Statistics Modal -->
    <div id="games-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Game Statistics</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="game-stats-row">
                    <div class="game-stat-item">
                        <label>Total Games Played:</label>
                        <span class="game-stat-value" id="modal-totalgames">-</span>
                    </div>
                    <div class="game-stat-item">
                        <label>Total Games Won:</label>
                        <span class="game-stat-value" id="modal-gameswon">-</span>
                    </div>
                    <div class="game-stat-item">
                        <label>Win Rate:</label>
                        <span class="game-stat-value" id="modal-winrate">-</span>
                    </div>
                </div>
                <div class="game-stats-row">
                    <div class="game-stat-item">
                        <label>Total Coins Spent:</label>
                        <span class="game-stat-value" id="modal-coinsspent">‚Çπ-</span>
                    </div>
                    <div class="game-stat-item">
                        <label>Total Coins Won:</label>
                        <span class="game-stat-value" id="modal-coinswon-stat">‚Çπ-</span>
                    </div>
                    <div class="game-stat-item">
                        <label>Net Profit/Loss:</label>
                        <span class="game-stat-value" id="modal-netprofit">‚Çπ-</span>
                    </div>
                </div>
                <div class="game-history-section">
                    <h3>Recent Games</h3>
                    <div id="game-history-list" class="game-history-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Block/Unblock Confirmation Modal -->
    <div id="block-modal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Block User</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="block-message">Are you sure you want to block this user?</p>
                <textarea id="block-reason" placeholder="Enter block reason (optional)" class="block-reason-textarea"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeBlockModal()">Cancel</button>
                <button class="btn btn-confirm" onclick="confirmBlockUser()">Confirm Block</button>
            </div>
        </div>
    </div>

    <script>
        // Session storage
        const adminUsername = sessionStorage.getItem('username') || 'Admin';
        document.getElementById('admin-username').textContent = adminUsername;

        // Global variables
        let allUsers = [];
        let filteredUsers = [];
        let currentPage = 1;
        const usersPerPage = 10;
        let currentUserId = null;
        let currentBlockAction = null;

        // Sidebar navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (this.classList.contains('menu-item') && !e.target.closest('.menu-toggle')) {
                    const section = this.getAttribute('data-section');
                    if (section) {
                        showSection(section);
                        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                        this.classList.add('active');
                    }
                }
            });
        });

        // Submenu toggle
        document.querySelectorAll('.menu-toggle').forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.preventDefault();
                const target = this.getAttribute('data-target');
                const submenu = document.getElementById(target);
                submenu.classList.toggle('open');
                this.classList.toggle('open');
            });
        });

        // Section display
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
                document.getElementById('header-subtitle').textContent = 
                    section.querySelector('h2').textContent;
                
                if (sectionId === 'users') {
                    loadUsers();
                } else if (sectionId === 'dashboard') {
                    loadStats();
                }
            }
        }

        // Load Users
        async function loadUsers() {
            try {
                document.getElementById('loading-indicator').style.display = 'block';
                document.getElementById('no-users').style.display = 'none';
                
                const response = await fetch('/api/admin/users');
                allUsers = await response.json();
                filteredUsers = allUsers;
                currentPage = 1;
                
                displayUsers();
                document.getElementById('loading-indicator').style.display = 'none';
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('no-users').style.display = 'block';
            }
        }

        // Display Users
        function displayUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';

            if (filteredUsers.length === 0) {
                document.getElementById('no-users').style.display = 'block';
                return;
            }

            document.getElementById('no-users').style.display = 'none';

            const startIdx = (currentPage - 1) * usersPerPage;
            const endIdx = startIdx + usersPerPage;
            const pageUsers = filteredUsers.slice(startIdx, endIdx);

            pageUsers.forEach((user, idx) => {
                const rowNum = startIdx + idx + 1;
                const createdDate = new Date(user.created_at);
                const formattedDate = createdDate.toLocaleDateString('en-IN') + ' ' + 
                                     createdDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                // Calculate game stats
                const gameStats = calculateGameStats(user.id);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="col-sno">${rowNum}</td>
                    <td class="col-userid">${user.id}</td>
                    <td class="col-referid">
                        ${user.refer_id ? `<button class="link-btn" onclick="showReferModal('${user.refer_id}')">REF-${user.refer_id}</button>` : '-'}
                    </td>
                    <td class="col-joined">${formattedDate}</td>
                    <td class="col-balance">
                        <button class="link-btn balance-btn" onclick="showWalletModal(${user.id})">‚Çπ${user.balance}</button>
                    </td>
                    <td class="col-games">
                        <button class="link-btn games-btn" onclick="showGamesModal(${user.id})">
                            ${gameStats.total}
                        </button>
                    </td>
                    <td class="col-won">${gameStats.won}</td>
                    <td class="col-coinswon">‚Çπ${gameStats.coinsWon}</td>
                    <td class="col-login">
                        <button class="link-btn login-btn" onclick="showLoginModal(${user.id}, '${user.username}')">View</button>
                    </td>
                    <td class="col-action">
                        <button class="action-toggle-btn ${user.status === 'blocked' ? 'blocked' : 'active'}" 
                                onclick="toggleBlockUser(${user.id}, '${user.status}')"
                                data-status="${user.status}">
                            ${user.status === 'blocked' ? 'Unblock' : 'Block'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        // Calculate game stats
        function calculateGameStats(userId) {
            // This will be populated from API in next step
            // For now, returning placeholder
            return {
                total: 0,
                won: 0,
                coinsWon: 0
            };
        }

        // Search functionality
        document.getElementById('search-users').addEventListener('keyup', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm) ||
                user.id.toString().includes(searchTerm)
            );
            currentPage = 1;
            displayUsers();
        });

        // Pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                displayUsers();
                window.scrollTo(0, 0);
            }
        });

        document.getElementById('next-page').addEventListener('click', function() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayUsers();
                window.scrollTo(0, 0);
            }
        });

        // Refresh users
        document.getElementById('refresh-users').addEventListener('click', loadUsers);

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Show Login Modal
        function showLoginModal(userId, username) {
            currentUserId = userId;
            document.getElementById('modal-userid').textContent = userId;
            document.getElementById('modal-username').textContent = username;
            document.getElementById('modal-password').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            document.getElementById('login-modal').style.display = 'flex';
        }

        // Show Refer Modal
        function showReferModal(referId) {
            document.getElementById('modal-referid').textContent = referId;
            document.getElementById('modal-agentname').textContent = 'Agent Name';
            document.getElementById('modal-referdate').textContent = new Date().toLocaleDateString('en-IN');
            document.getElementById('refer-modal').style.display = 'flex';
        }

        // Show Wallet Modal
        function showWalletModal(userId) {
            currentUserId = userId;
            const user = allUsers.find(u => u.id === userId);
            document.getElementById('modal-balance').textContent = `‚Çπ${user.balance}`;
            document.getElementById('modal-earned').textContent = `‚Çπ${user.balance}`;
            document.getElementById('modal-spent').textContent = `‚Çπ0`;
            document.getElementById('wallet-modal').style.display = 'flex';
        }

        // Show Games Modal
        function showGamesModal(userId) {
            currentUserId = userId;
            document.getElementById('modal-totalgames').textContent = '0';
            document.getElementById('modal-gameswon').textContent = '0';
            document.getElementById('modal-winrate').textContent = '0%';
            document.getElementById('modal-coinsspent').textContent = '‚Çπ0';
            document.getElementById('modal-coinswon-stat').textContent = '‚Çπ0';
            document.getElementById('modal-netprofit').textContent = '‚Çπ0';
            document.getElementById('game-history-list').innerHTML = '<p>No games found</p>';
            document.getElementById('games-modal').style.display = 'flex';
        }

        // Copy to clipboard
        function copyToClipboard(selector) {
            const element = document.querySelector(selector);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            });
        }

        // Toggle password visibility
        function togglePassword() {
            const input = document.getElementById('modal-password');
            const btn = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è Show';
            }
        }

        // Copy password
        function copyPassword() {
            const input = document.getElementById('modal-password');
            const tempInput = document.createElement('input');
            tempInput.type = 'text';
            tempInput.value = input.value;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert('Password copied to clipboard!');
        }

        // Block/Unblock user
        function toggleBlockUser(userId, status) {
            currentUserId = userId;
            currentBlockAction = status === 'blocked' ? 'unblock' : 'block';
            const action = currentBlockAction === 'block' ? 'Block' : 'Unblock';
            document.querySelector('.modal-header h2').textContent = currentBlockAction === 'block' ? 'Block User' : 'Unblock User';
            document.getElementById('block-message').textContent = `Are you sure you want to ${action.toLowerCase()} this user?`;
            document.getElementById('block-reason').style.display = currentBlockAction === 'block' ? 'block' : 'none';
            document.getElementById('block-modal').style.display = 'flex';
        }

        function closeBlockModal() {
            document.getElementById('block-modal').style.display = 'none';
            document.getElementById('block-reason').value = '';
        }

        async function confirmBlockUser() {
            const endpoint = currentBlockAction === 'block' 
                ? `/api/admin/users/${currentUserId}/block`
                : `/api/admin/users/${currentUserId}/unblock`;
            
            const data = currentBlockAction === 'block' 
                ? { reason: document.getElementById('block-reason').value }
                : {};
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert(`User ${currentBlockAction === 'block' ? 'blocked' : 'unblocked'} successfully!`);
                    closeBlockModal();
                    loadUsers();
                } else {
                    alert('Error updating user status');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating user status');
            }
        }

        // Load dashboard stats
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const stats = await response.json();
                
                document.getElementById('total-users').textContent = stats.total_users;
                document.getElementById('active-users').textContent = stats.active_users;
                document.getElementById('inactive-users').textContent = stats.inactive_users;
                document.getElementById('total-revenue').textContent = `‚Çπ${stats.total_revenue.toLocaleString()}`;
                document.getElementById('total-deposit').textContent = `‚Çπ${stats.total_deposit.toLocaleString()}`;
                document.getElementById('total-withdrawal').textContent = `‚Çπ${stats.total_withdrawal.toLocaleString()}`;
                document.getElementById('active-games').textContent = stats.active_games;
                document.getElementById('open-tickets').textContent = stats.open_tickets;
                document.getElementById('blocked-users').textContent = stats.blocked_users;
                
                const now = new Date();
                document.getElementById('last-update').textContent = now.toLocaleTimeString();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Refresh stats
        document.getElementById('refresh-stats').addEventListener('click', loadStats);

        // Initial load
        loadUsers();

        // Credit amount
        function creditAmount() {
            const amount = document.getElementById('amount-input').value;
            if (!amount || isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            updateBalance(currentUserId, 'add', parseFloat(amount));
        }

        // Debit amount
        function debitAmount() {
            const amount = document.getElementById('amount-input').value;
            if (!amount || isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            updateBalance(currentUserId, 'debit', parseFloat(amount));
        }

        // Update balance
        async function updateBalance(userId, type, amount) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: type,
                        amount: amount,
                        reason: 'Admin transaction'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    document.getElementById('amount-input').value = '';
                    loadUsers();
                    closeModal('wallet-modal');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating balance');
            }
        }
    </script>
</body>
</html>
