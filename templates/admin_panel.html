<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Game of Five</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }

    .admin-wrapper { display: flex; height: 100vh; width: 100%; }

    /* SIDEBAR */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      border-right: 2px solid #334155;
      padding: 25px 0;
      overflow-y: auto;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 100;
    }

    .sidebar-header {
      padding: 0 20px 30px 20px;
      border-bottom: 2px solid #334155;
      margin-bottom: 20px;
    }

    .sidebar-header h1 {
      font-size: 24px;
      font-weight: bold;
      color: #10b981;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
    }

    .sidebar-menu { list-style: none; padding: 0; margin: 0; }
    .sidebar-menu li { margin: 0; padding: 0; }

    .sidebar-menu a {
      display: block;
      padding: 15px 25px;
      color: #cbd5e1;
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
    }

    .sidebar-menu a:hover {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border-left-color: #10b981;
      padding-left: 28px;
    }

    .sidebar-menu a.active {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border-left-color: #10b981;
      font-weight: 600;
    }

    .menu-divider { height: 1px; background: #334155; margin: 15px 0; }

    /* MAIN CONTENT */
    .main-content {
      margin-left: 280px;
      flex: 1;
      display: flex;
      flex-direction: column;
      width: calc(100% - 280px);
      height: 100vh;
      overflow: hidden;
    }

    .top-header {
      background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%);
      border-bottom: 2px solid #334155;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .top-header h1 { font-size: 32px; font-weight: bold; color: #e2e8f0; margin: 0; }

    .logout-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(239,68,68,0.3);
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239,68,68,0.4);
    }

    /* CONTENT */
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 40px;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }

    .section { display: none; animation: fadeIn 0.3s ease-in; }
    .section.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* DASHBOARD */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: 2px solid #334155;
      border-radius: 12px;
      padding: 30px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, #10b981, #06b6d4);
    }

    .stat-card:hover {
      border-color: #10b981;
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(16,185,129,0.2);
    }

    .stat-label {
      color: #94a3b8;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .stat-value { color: #10b981; font-size: 42px; font-weight: bold; margin: 0; }

    .stat-icon {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 32px;
      opacity: 0.2;
    }

    /* SECTION */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .section-title { font-size: 28px; font-weight: bold; color: #e2e8f0; margin: 0; }

    .controls { display: flex; gap: 12px; margin-bottom: 25px; flex-wrap: wrap; }

    .search-box { display: flex; gap: 12px; flex: 1; min-width: 300px; }

    .search-box input {
      flex: 1;
      padding: 12px 16px;
      background: #1e293b;
      border: 2px solid #334155;
      color: #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
    }

    .search-box button, .btn-primary {
      padding: 12px 24px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .search-box button:hover, .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16,185,129,0.3);
    }

    /* TABLE */
    .table-container {
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }

    .data-table thead {
      background: linear-gradient(90deg, #0f172a 0%, #1e293b 100%);
      border-bottom: 2px solid #334155;
    }

    .data-table th {
      padding: 18px 20px;
      text-align: left;
      color: #94a3b8;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
      white-space: nowrap;
    }

    .data-table td {
      padding: 16px 20px;
      border-bottom: 1px solid #334155;
      color: #cbd5e1;
      vertical-align: middle;
    }

    .data-table tbody tr:hover { background: rgba(16,185,129,0.05); }

    /* BADGES */
    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
      white-space: nowrap;
    }

    .badge-active {
      background: rgba(16,185,129,0.2);
      color: #10b981;
      border: 1px solid rgba(16,185,129,0.3);
    }

    .badge-blocked {
      background: rgba(239,68,68,0.2);
      color: #ef4444;
      border: 1px solid rgba(239,68,68,0.3);
    }

    .badge-pending {
      background: rgba(245,158,11,0.2);
      color: #f59e0b;
      border: 1px solid rgba(245,158,11,0.3);
    }

    .badge-deposit {
      background: rgba(34,197,94,0.2);
      color: #22c55e;
      border: 1px solid rgba(34,197,94,0.3);
    }

    .badge-withdrawal {
      background: rgba(239,68,68,0.2);
      color: #ef4444;
      border: 1px solid rgba(239,68,68,0.3);
    }

    /* BUTTONS */
    .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-small {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .btn-edit {
      background: rgba(59,130,246,0.2);
      color: #3b82f6;
      border: 1px solid rgba(59,130,246,0.3);
    }
    .btn-edit:hover { background: rgba(59,130,246,0.3); }

    .btn-view {
      background: rgba(6,182,212,0.2);
      color: #06b6d4;
      border: 1px solid rgba(6,182,212,0.3);
    }
    .btn-view:hover { background: rgba(6,182,212,0.3); }

    .btn-block {
      background: rgba(239,68,68,0.2);
      color: #ef4444;
      border: 1px solid rgba(239,68,68,0.3);
    }
    .btn-block:hover { background: rgba(239,68,68,0.3); }

    .btn-unblock {
      background: rgba(16,185,129,0.2);
      color: #10b981;
      border: 1px solid rgba(16,185,129,0.3);
    }
    .btn-unblock:hover { background: rgba(16,185,129,0.3); }

    /* MODAL */
    .modal {
      display: none !important;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    }
    .modal.active { display: flex !important; }

    .modal-content {
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 12px;
      padding: 40px;
      width: 90%;
      max-width: 650px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      margin: 20px auto;
    }

    .modal-header { margin-bottom: 25px; }
    .modal-header h2 { color: #e2e8f0; font-size: 24px; margin: 0; font-weight: bold; }
    .modal-header p { color: #94a3b8; margin: 8px 0 0 0; }

    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      color: #94a3b8;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 12px 16px;
      background: #0f172a;
      border: 2px solid #334155;
      color: #e2e8f0;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
    }

    .form-group textarea { resize: vertical; min-height: 100px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    .modal-footer { display: flex; gap: 12px; margin-top: 30px; }
    .btn-modal {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-save {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16,185,129,0.3);
    }

    .btn-cancel { background: #334155; color: #cbd5e1; }
    .btn-cancel:hover { background: #475569; }

    /* DETAILS */
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .detail-item { background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #334155; }
    .detail-label { color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; font-weight: 600; }
    .detail-value { color: #10b981; font-size: 18px; font-weight: bold; }

    /* STATES */
    .loading { text-align: center; padding: 60px 20px; color: #94a3b8; font-size: 16px; }
    .no-data { text-align: center; padding: 60px 20px; color: #64748b; font-size: 15px; }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .sidebar { width: 260px; }
      .main-content { width: calc(100% - 260px); margin-left: 260px; }
      .form-row { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .admin-wrapper { flex-direction: column; }
      .sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 2px solid #334155;
        position: relative;
      }
      .main-content { width: 100%; margin-left: 0; }
      .modal-content { width: 95%; }
      .details-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="admin-wrapper">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>‚öôÔ∏è Admin Panel</h1>
      </div>

      <ul class="sidebar-menu">
        <li><a class="menu-link active" data-section="dashboard">üìä Dashboard</a></li>
        <li><a class="menu-link" data-section="users">üë• Users</a></li>
        <li><a class="menu-link" data-section="agents">üë®‚Äçüíº Agents</a></li>
        <li><a class="menu-link" data-section="games">üéÆ Games</a></li>
        <li><a class="menu-link" data-section="transactions">üí∞ Transactions</a></li>
        <li><a class="menu-link" data-section="wallet">üí∏ Wallet</a></li>
        <li><a class="menu-link" data-section="referrals">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Referrals</a></li>
        <li><a class="menu-link" data-section="promos">üé´ Promos</a></li>
        <li><a class="menu-link" data-section="announcements">üì¢ Announcements</a></li>
        <li><a class="menu-link" data-section="reports">üìà Reports</a></li>
        <li><a class="menu-link" data-section="security">üõ°Ô∏è Security</a></li>

        <li><div class="menu-divider"></div></li>
        <li><a class="menu-link" onclick="logout()" style="color:#ef4444;">üö™ Logout</a></li>
      </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="top-header">
        <h1 id="pageTitle">Dashboard</h1>
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
      </div>

      <div class="content-area">
        <!-- DASHBOARD -->
        <div id="dashboard" class="section active">
          <div class="dashboard-grid">
            <div class="stat-card">
              <div class="stat-icon">üë•</div>
              <div class="stat-label">Total Users</div>
              <p class="stat-value" id="totalUsers">0</p>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üë®‚Äçüíº</div>
              <div class="stat-label">Total Agents</div>
              <p class="stat-value" id="totalAgents">0</p>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üéÆ</div>
              <div class="stat-label">Active Games</div>
              <p class="stat-value" id="activeGames">0</p>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üí∞</div>
              <div class="stat-label">Total Revenue</div>
              <p class="stat-value" id="totalRevenue">‚Çπ0</p>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìà</div>
              <div class="stat-label">Total Deposits</div>
              <p class="stat-value" id="totalDeposits">‚Çπ0</p>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìâ</div>
              <div class="stat-label">Total Withdrawals</div>
              <p class="stat-value" id="totalWithdrawals">‚Çπ0</p>
            </div>
          </div>
        </div>

        <!-- USERS -->
        <div id="users" class="section">
          <div class="section-header">
            <h2 class="section-title">Users Management</h2>
          </div>

          <div class="controls">
            <div class="search-box">
              <input type="text" id="searchUsers" placeholder="Search by username or email..." />
              <button onclick="loadUsers()">üîç Search</button>
            </div>
          </div>

          <div id="usersLoading" class="loading">Loading users...</div>

          <div id="usersTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                   <th>S.No.</th>
                   <th>User Name</th>
                   <th>Agent Name</th>
                   <th>Email</th>
                   <th>Status</th>
                   <th>Total Games</th>
                   <th>Winning Amount</th>
                   <th>Wallet Balance</th>
                   <th>Joining</th>
                   <th>Action</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- USER GAMES (NEW PAGE) -->
        <div id="userGames" class="section">
          <div class="section-header">
            <h2 class="section-title" id="userGamesTitle">User Games</h2>
            <button class="btn-primary" onclick="backToUsers()">‚Üê Back</button>
          </div>

          <div class="controls">
            <div class="search-box">
              <input type="text" id="searchUserGames" placeholder="Search by round code / game type..." />
              <button onclick="displayUserGames()">üîç Search</button>
            </div>
          </div>

          <div id="userGamesLoading" class="loading">Loading games...</div>

          <div id="userGamesTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Round Code</th>
                    <th>Game</th>
                    <th>Bet Number(s)</th>
                    <th>Winning #</th>
                    <th>Status</th>
                    <th>Net/Amount</th>
                    <th>Date/Time</th>
                  </tr>
                </thead>

                <tbody id="userGamesTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- AGENTS -->
        <div id="agents" class="section">
          <div class="section-header">
            <h2 class="section-title">Agents Management</h2>
            <button class="btn-primary" onclick="openAddAgentModal()">‚ûï Add Agent</button>
          </div>
          <div id="agentsLoading" class="loading">Loading agents...</div>
          <div id="agentsTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Round Code</th>
                    <th>Game</th>
                    <th>Bet Number(s)</th>
                    <th>Winning #</th>
                    <th>Status</th>
                    <th>Net/Amount</th>
                    <th>Date/Time</th>
                   </tr>
                </thead>

                <tbody id="agentsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- GAMES -->
        <div id="games" class="section">
          <div class="section-header">
            <h2 class="section-title">Game Statistics</h2>
          </div>

          <div class="controls">
            <div class="search-box">
              <input type="text" id="searchGames" placeholder="Search by round code or game type..." />
              <button onclick="loadGames()">üîç Search</button>
            </div>
          </div>

          <div id="gamesLoading" class="loading">Loading games...</div>
          <div id="gamesTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Round Code</th>
                    <th>Game Type</th>
                    <th>Players</th>
                    <th>Winning #</th>
                    <th>Total Bets</th>
                    <th>Date/Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="gamesTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- TRANSACTIONS -->
        <div id="transactions" class="section">
          <div class="section-header">
            <h2 class="section-title">Transactions Log</h2>
          </div>

          <div class="controls">
            <div class="search-box">
              <input type="text" id="searchTransactions" placeholder="Search by user or transaction ID..." />
              <button onclick="loadTransactions()">üîç Search</button>
            </div>
          </div>

          <div id="transactionsLoading" class="loading">Loading transactions...</div>
          <div id="transactionsTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Txn ID</th>
                    <th>User</th>
                    <th>Type</th>
                    <th>Amount (‚Çπ)</th>
                    <th>Status</th>
                    <th>Date/Time</th>
                    <th>Reference</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="transactionsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- WALLET -->
        <div id="wallet" class="section">
          <div class="section-header">
            <h2 class="section-title">Wallet Management</h2>
          </div>

          <div class="controls">
            <div class="search-box">
              <input type="text" id="searchWallet" placeholder="Search by username..." list="usersDatalist" />
              <button onclick="displayWalletUsers()">üîç Search</button>
            </div>
            <button class="btn-primary" onclick="openAddFundsModal()">‚ûï Add Funds</button>
            <button class="btn-primary" onclick="openDeductFundsModal()">‚ûñ Deduct Funds</button>
          </div>

          <datalist id="usersDatalist"></datalist>

          <div id="walletLoading" class="loading">Loading wallet users...</div>
          <div id="walletTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Current Balance</th>
                    <th>Total Deposits</th>
                    <th>Total Withdrawals</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="walletTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- REFERRALS -->
        <div id="referrals" class="section">
          <div class="section-header">
            <h2 class="section-title">Referral & MLM System</h2>
          </div>

          <div class="controls">
            <div class="search-box">
              <input type="text" id="searchReferral" placeholder="Search by agent name..." />
              <button onclick="loadReferrals()">üîç Search</button>
            </div>
          </div>

          <div id="referralsLoading" class="loading">Loading referral data...</div>
          <div id="referralsTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Agent</th>
                    <th>Referred Users</th>
                    <th>Active Users</th>
                    <th>User Deposits</th>
                    <th>User Withdrawals</th>
                    <th>Commission Rate</th>
                    <th>Total Commission</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="referralsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- PROMOS -->
        <div id="promos" class="section">
          <div class="section-header">
            <h2 class="section-title">Promo Codes</h2>
            <button class="btn-primary" onclick="openAddPromoModal()">‚ûï Create Promo</button>
          </div>

          <div id="promosLoading" class="loading">Loading promos...</div>
          <div id="promosTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Type</th>
                    <th>Discount</th>
                    <th>Max Uses</th>
                    <th>Used</th>
                    <th>Valid Till</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="promosTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ANNOUNCEMENTS -->
        <div id="announcements" class="section">
          <div class="section-header">
            <h2 class="section-title">Announcements</h2>
            <button class="btn-primary" onclick="openAnnounceModal()">üì¢ Send Announcement</button>
          </div>

          <div id="announcementsLoading" class="loading">Loading announcements...</div>
          <div id="announcementsTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Message</th>
                    <th>Target</th>
                    <th>Sent Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="announcementsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- REPORTS -->
        <div id="reports" class="section">
          <div class="section-header">
            <h2 class="section-title">Reports & Analytics</h2>
          </div>

          <div class="dashboard-grid">
            <div class="stat-card">
              <div class="stat-icon">üë•</div>
              <div class="stat-label">New Users (30d)</div>
              <p class="stat-value" id="newUsers30d">0</p>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üí∞</div>
              <div class="stat-label">Revenue (30d)</div>
              <p class="stat-value" id="revenue30d">‚Çπ0</p>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üéÆ</div>
              <div class="stat-label">Games Played (30d)</div>
              <p class="stat-value" id="gamesPlayed30d">0</p>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìä</div>
              <div class="stat-label">Avg Win Rate</div>
              <p class="stat-value" id="avgWinRate">0%</p>
            </div>
          </div>
        </div>

        <!-- SECURITY -->
        <div id="security" class="section">
          <div class="section-header">
            <h2 class="section-title">Security Settings</h2>
          </div>
          <div class="controls">
            <button class="btn-primary" onclick="openSecurityModal()">üîí Manage Security</button>
          </div>
          <div class="no-data">Security settings and 2FA configuration coming soon...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS -->

  <!-- Add Agent -->
  <div id="addAgentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ûï Add New Agent</h2>
        <p>Create a new agent account</p>
      </div>
      <form id="addAgentForm">
        <div class="form-group">
          <label>Agent Name</label>
          <input type="text" id="agentName" placeholder="Enter agent name" required />
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="agentEmail" placeholder="agent@example.com" required />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="agentUsername" placeholder="agent_username" required />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="agentPassword" placeholder="Password" required />
          </div>
        </div>
        <div class="form-group">
          <label>Salary Percentage (%)</label>
          <input type="number" id="agentSalaryPercent" placeholder="5" min="0" max="100" required />
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-modal btn-save">Add Agent</button>
          <button type="button" class="btn-modal btn-cancel" onclick="closeAddAgentModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Profile -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚úèÔ∏è Edit User</h2>
        <p>Update profile details (not wallet)</p>
      </div>

      <form id="editUserForm">
        <input type="hidden" id="editUserId" />

        <div class="form-row">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="editUsername" disabled />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="editStatus">
              <option value="active">Active</option>
              <option value="blocked">Blocked</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="editDisplayName" placeholder="Display name" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="editEmail" placeholder="Email" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Country</label>
            <input type="text" id="editCountry" placeholder="Country" />
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="text" id="editPhone" placeholder="Phone" />
          </div>
        </div>

        <div class="form-group">
          <label>Block Reason (only if blocked)</label>
          <input type="text" id="editBlockReason" placeholder="Reason..." />
        </div>

        <div class="form-group">
          <label>Reset Password (optional)</label>
          <input type="password" id="editPassword" placeholder="Leave blank to keep unchanged" />
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn-modal btn-save">Save</button>
          <button type="button" class="btn-modal btn-cancel" onclick="closeEditUserModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Funds -->
  <div id="addFundsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ûï Add Funds</h2>
        <p>Add funds to user wallet</p>
      </div>
      <form id="addFundsForm">
        <div class="form-group">
          <label>Select User</label>
          <input type="text" id="addFundsUser" placeholder="Type username..." list="usersDatalist" required />
        </div>
        <div class="form-group">
          <label>Amount (‚Çπ)</label>
          <input type="number" id="addFundsAmount" placeholder="1000" min="0" required />
        </div>
        <div class="form-group">
          <label>Reason</label>
          <textarea id="addFundsReason" placeholder="Reason for adding funds..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-modal btn-save">Add Funds</button>
          <button type="button" class="btn-modal btn-cancel" onclick="closeAddFundsModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Deduct Funds -->
  <div id="deductFundsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ûñ Deduct Funds</h2>
        <p>Deduct funds from user wallet</p>
      </div>
      <form id="deductFundsForm">
        <div class="form-group">
          <label>Select User</label>
          <input type="text" id="deductFundsUser" placeholder="Type username..." list="usersDatalist" required />
        </div>
        <div class="form-group">
          <label>Amount (‚Çπ)</label>
          <input type="number" id="deductFundsAmount" placeholder="1000" min="0" required />
        </div>
        <div class="form-group">
          <label>Reason</label>
          <textarea id="deductFundsReason" placeholder="Reason for deducting funds..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-modal btn-save">Deduct Funds</button>
          <button type="button" class="btn-modal btn-cancel" onclick="closeDeductFundsModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Promo -->
  <div id="addPromoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üé´ Create Promo Code</h2>
        <p>Create a new promotional code</p>
      </div>
      <form id="addPromoForm">
        <div class="form-group">
          <label>Promo Code</label>
          <input type="text" id="promoCode" placeholder="PROMO50" required />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Type</label>
            <select id="promoType" required>
              <option value="percentage">Percentage Discount</option>
              <option value="flat">Flat Amount</option>
            </select>
          </div>
          <div class="form-group">
            <label>Discount Value</label>
            <input type="number" id="promoValue" placeholder="50" min="0" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Max Uses</label>
            <input type="number" id="promoMaxUses" placeholder="100" min="0" required />
          </div>
          <div class="form-group">
            <label>Valid Till</label>
            <input type="date" id="promoValidTill" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-modal btn-save">Create Promo</button>
          <button type="button" class="btn-modal btn-cancel" onclick="closeAddPromoModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Announcement -->
  <div id="announceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì¢ Send Announcement</h2>
        <p>Send message to users</p>
      </div>
      <form id="announceForm">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="announceTitle" placeholder="Announcement title" required />
        </div>
        <div class="form-group">
          <label>Message</label>
          <textarea id="announceMessage" placeholder="Enter announcement message..." required></textarea>
        </div>
        <div class="form-group">
          <label>Target Users</label>
          <select id="announceTarget" required>
            <option value="all">All Users</option>
            <option value="active">Active Users Only</option>
            <option value="inactive">Inactive Users</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-modal btn-save">Send Announcement</button>
          <button type="button" class="btn-modal btn-cancel" onclick="closeAnnounceModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Details -->
  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="detailsTitle">Details</h2>
        <p id="detailsSubtitle" style="color:#94a3b8; margin-top:8px;"></p>
      </div>
      <div id="detailsContent"></div>
      <div class="modal-footer">
        <button class="btn-modal btn-cancel" onclick="closeDetailsModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    let allUsers = [];
    let allAgents = [];
    let allGames = [];
    let allTxns = [];
    let allWalletUsers = [];

    // ------------------------
    // Helpers
    // ------------------------
    async function apiGet(url) {
      const r = await fetch(url, { credentials: 'same-origin' });
      const ct = r.headers.get('content-type') || '';
      let data = null;

      if (ct.includes('application/json')) data = await r.json().catch(() => null);
      else data = await r.text().catch(() => '');

      if (!r.ok) {
        const msg = (data && data.message) ? data.message : (typeof data === 'string' ? data : `HTTP ${r.status}`);
        throw new Error(`${url} -> ${msg}`);
      }
      return data;
    }

    async function apiSend(url, method, bodyObj) {
      const r = await fetch(url, {
        method,
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: bodyObj ? JSON.stringify(bodyObj) : undefined
      });
      const ct = r.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await r.json().catch(() => ({})) : await r.text().catch(() => '');
      if (!r.ok) throw new Error((data && data.message) ? data.message : `HTTP ${r.status}`);
      return data;
    }

    function fmtINR(n) {
      const v = Number(n || 0);
      return '‚Çπ' + v.toLocaleString('en-IN');
    }

    function safeLower(x) {
      return String(x || '').toLowerCase();
    }

    function userStatusBadgeClass(status) {
      return safeLower(status) === 'blocked' ? 'badge-blocked' : 'badge-active';
    }

    function gameStatusBadgeClass(status) {
      const s = safeLower(status);
      if (s === 'active') return 'badge-active';
      if (s === 'completed' || s === 'betting_closed') return 'badge-pending';
      if (s === 'finished') return 'badge-deposit';
      return 'badge-pending';
    }

    function txnTypeBadgeClass(type) {
      const t = String(type || '').toUpperCase();
      if (t === 'WIN') return 'badge-active';
      if (t === 'BET') return 'badge-pending';
      if (t === 'ADDED') return 'badge-deposit';
      if (t === 'DEDUCTED') return 'badge-withdrawal';
      return 'badge-pending';
    }

    function txnStatusBadgeClass(status) {
      const s = String(status || '').toUpperCase();
      return (s === 'DONE' || s === 'WIN' || s === 'LOSE') ? 'badge-active' : 'badge-pending';
    }

    function logout() {
      window.location.href = '/logout';
    }

    // ------------------------
    // Menu
    // ------------------------
    document.addEventListener('DOMContentLoaded', function () {
      setupMenuLinks();
      wireForms();

      // Load initial
      loadStats();
      loadUsers();
    });

    function setupMenuLinks() {
      document.querySelectorAll('.menu-link').forEach((link) => {
        link.addEventListener('click', function (e) {
          if (this.getAttribute('onclick')) return;
          e.preventDefault();
          const section = this.dataset.section;
          switchSection(section);
          document.querySelectorAll('.menu-link').forEach((l) => l.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }

    function switchSection(section) {
      document.querySelectorAll('.section').forEach((s) => s.classList.remove('active'));
      const el = document.getElementById(section);
      if (el) el.classList.add('active');

      const titles = {
        dashboard: 'Dashboard',
        users: 'Users Management',
        userGames: 'User Games',
        agents: 'Agents Management',
        games: 'Game Statistics',
        transactions: 'Transactions Log',
        wallet: 'Wallet Management',
        referrals: 'Referral System',
        promos: 'Promo Codes',
        announcements: 'Announcements',
        reports: 'Reports & Analytics',
        security: 'Security Settings',
      };
      document.getElementById('pageTitle').textContent = titles[section] || 'Admin Panel';

      if (section === 'dashboard') loadStats();
      if (section === 'users') loadUsers();
      if (section === 'agents') loadAgents();
      if (section === 'games') loadGames();
      if (section === 'transactions') loadTransactions();
      if (section === 'wallet') loadWalletUsers();
      if (section === 'referrals') loadReferrals();
      if (section === 'promos') loadPromos();
      if (section === 'announcements') loadAnnouncements();
      if (section === 'reports') loadReports();
    }

    function wireForms() {
      document.getElementById('addAgentForm')?.addEventListener('submit', submitAddAgent);
      document.getElementById('addFundsForm')?.addEventListener('submit', submitAddFunds);
      document.getElementById('deductFundsForm')?.addEventListener('submit', submitDeductFunds);
      document.getElementById('addPromoForm')?.addEventListener('submit', submitAddPromo);
      document.getElementById('announceForm')?.addEventListener('submit', submitAnnounce);
      document.getElementById('editUserForm')?.addEventListener('submit', submitEditUser);

      document.getElementById('searchUsers')?.addEventListener('keyup', filterAndDisplayUsers);
      document.getElementById('searchGames')?.addEventListener('keyup', displayGames);
      document.getElementById('searchTransactions')?.addEventListener('keyup', displayTransactions);
      document.getElementById('searchWallet')?.addEventListener('keyup', displayWalletUsers);
      document.getElementById('searchUserGames')?.addEventListener('keyup', displayUserGames);
    }

    // ------------------------
    // Dashboard
    // ------------------------
    async function loadStats() {
      try {
        const data = await apiGet('/api/admin/stats');

        document.getElementById('totalUsers').textContent = data.totalusers ?? 0;
        document.getElementById('activeGames').textContent = data.activegames ?? 0;
        document.getElementById('totalRevenue').textContent = fmtINR(data.totalrevenue ?? 0);
        document.getElementById('totalDeposits').textContent = fmtINR(data.totaldeposit ?? 0);
        document.getElementById('totalWithdrawals').textContent = fmtINR(data.totalwithdrawal ?? 0);

        // Agents are not implemented in backend yet
        document.getElementById('totalAgents').textContent = 0;
      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }

    // ------------------------
    // Users
    // ------------------------
    async function loadUsers() {
      document.getElementById('usersLoading').style.display = 'block';
      document.getElementById('usersTableContainer').style.display = 'none';

      try {
        const data = await apiGet('/api/admin/users');

        // Store profile fields if backend sends them
        allUsers = (data || []).map(u => ({
          id: u.id,
          username: u.username || '-',
          displayname: u.displayname || u.displayName || '',
          email: u.email || '-',
          country: u.country || '',
          phone: u.phone || '',
          agentname: u.agentname || u.refer_id || u.referid || '-',
          balance: Number(u.balance || 0),
          gamesplayed: Number(u.gamesplayed || 0),
          status: (u.status || (u.isblocked ? 'blocked' : 'active')),
          createdat: u.createdat || '-',
          blockreason: u.blockreason || u.blockReason || '',
          total_games: Number(u.total_games ?? u.gamesplayed ?? 0),
          winning_amount: Number(u.winning_amount ?? u.winningamount ?? 0),
          joining: u.joining ?? u.createdat ?? "-",

        }));

        buildUserDatalist();
        filterAndDisplayUsers();

        document.getElementById('usersLoading').style.display = 'none';
        document.getElementById('usersTableContainer').style.display = 'block';
      } catch (err) {
        console.error('Error loading users:', err);
        document.getElementById('usersLoading').innerHTML = `<div style="color:#ef4444;">Error: ${err.message}</div>`;
      }
    }

    function buildUserDatalist() {
      const dl = document.getElementById('usersDatalist');
      if (!dl) return;
      dl.innerHTML = '';
      (allUsers || []).forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.username;
        dl.appendChild(opt);
      });
    }

    function filterAndDisplayUsers() {
      const search = safeLower(document.getElementById('searchUsers')?.value);
      const filtered = (allUsers || []).filter((u) => {
        const uname = safeLower(u.username);
        const email = safeLower(u.email);
        return uname.includes(search) || email.includes(search);
      });

      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';

      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="10" class="no-data">No users found</td></tr>`;
        return;
      }

      filtered.forEach((user, idx) => {
  const row = document.createElement("tr");

  const status = String(user.status || "active");
  const safeU = String(user.username || "").replace(/'/g, "\\'");
  const isBlocked = safeLower(status) === "blocked";

  const totalGames = Number(user.total_games ?? user.gamesplayed ?? 0);
  const winningAmount = Number(user.winning_amount ?? user.winningamount ?? 0);
  const walletBalance = Number(user.balance ?? 0);
  const joining = user.joining ?? user.createdat ?? "-";

  row.innerHTML = `
  <td>${idx + 1}</td>
  <td><strong>${user.username || "-"}</strong></td>
  <td>${user.agentname || "-"}</td>
  <td>${user.email || "-"}</td>
  <td><span class="badge ${userStatusBadgeClass(status)}">${status.toUpperCase()}</span></td>
  <td>
    <a href="javascript:void(0)"
       onclick="openUserGamesPage(${user.id}, '${safeU}')"
       style="color:#10b981; cursor:pointer">
      ${totalGames}
    </a>
  </td>
  <td>${fmtINR(winningAmount)}</td>
  <td>${fmtINR(walletBalance)}</td>
  <td>${joining}</td>
  <td>
    <div class="action-buttons">
      <button class="btn-small btn-edit" onclick="openEditUserModal(${user.id})">Edit</button>
      ${isBlocked
        ? `<button class="btn-small btn-unblock" onclick="unblockUser(${user.id})">Unblock</button>`
        : `<button class="btn-small btn-block" onclick="blockUser(${user.id})">Block</button>`
      }
    </div>
  </td>
`;
  tbody.appendChild(row);
});
}

    function openEditUserModal(userId) {
      const u = (allUsers || []).find(x => x.id === userId);
      if (!u) return;

      document.getElementById('editUserId').value = u.id;
      document.getElementById('editUsername').value = u.username || '';
      document.getElementById('editStatus').value = (u.status || 'active').toLowerCase();
      document.getElementById('editDisplayName').value = u.displayname || '';
      document.getElementById('editEmail').value = u.email || '';
      document.getElementById('editCountry').value = u.country || '';
      document.getElementById('editPhone').value = u.phone || '';
      document.getElementById('editBlockReason').value = u.blockreason || '';
      document.getElementById('editPassword').value = '';

      document.getElementById('editUserModal').classList.add('active');
    }

    function closeEditUserModal() {
      document.getElementById('editUserModal').classList.remove('active');
      document.getElementById('editUserForm')?.reset();
    }

    async function submitEditUser(e) {
      e.preventDefault();

      const userId = document.getElementById('editUserId').value;

      const payload = {
        email: document.getElementById('editEmail').value,
        displayname: document.getElementById('editDisplayName').value,
        displayName: document.getElementById('editDisplayName').value,
        country: document.getElementById('editCountry').value,
        phone: document.getElementById('editPhone').value,
        status: document.getElementById('editStatus').value,
        blockreason: document.getElementById('editBlockReason').value,
        blockReason: document.getElementById('editBlockReason').value
      };

      const pw = document.getElementById('editPassword').value;
      if (pw && pw.trim().length) payload.password = pw.trim();

      try {
        const res = await apiSend(`/api/admin/users/${userId}`, 'PUT', payload);
        alert(res.message || 'Updated');
        closeEditUserModal();
        await loadUsers();
        await loadStats();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function blockUser(userId) {
      const reason = prompt('Block reason (optional):', 'Blocked by admin') || 'Blocked by admin';
      if (!confirm('Block this user?')) return;

      try {
        const res = await apiSend(`/api/admin/users/${userId}/block`, 'POST', { reason });
        alert(res.message || 'Blocked');
        await loadUsers();
        await loadStats();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function unblockUser(userId) {
      if (!confirm('Unblock this user?')) return;

      try {
        const res = await apiSend(`/api/admin/users/${userId}/unblock`, 'POST', {});
        alert(res.message || 'Unblocked');
        await loadUsers();
        await loadStats();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ------------------------
    // User Games (table page)
    // ------------------------
    let currentUserGames = [];
    let currentUserMeta = { id: null, username: '' };

    function openUserGamesPage(userId, username) {
      currentUserMeta = { id: userId, username: username || '' };
      document.getElementById('userGamesTitle').textContent = `User Games: ${currentUserMeta.username} (#${userId})`;
      switchSection('userGames');
      loadUserGames(userId);
    }

    function backToUsers() {
      switchSection('users');
    }

    async function loadUserGames(userId) {
  document.getElementById("userGamesLoading").style.display = "block";
  document.getElementById("userGamesTableContainer").style.display = "none";
  currentUserGames = [];

  try {
    const data = await apiGet(`/api/admin/users/${userId}/games`);
    console.log("USER GAMES API SAMPLE:", data?.[0], data);

    // Backend already returns 1 row per round, so just map it to what displayUserGames() expects.
    currentUserGames = (Array.isArray(data) ? data : []).map(g => {
      const roundcode = g.roundcode || g.round_code || "-";
      const gametype  = g.gametype || g.game_type || "-";

      const numbers = Array.isArray(g.numbers)
        ? g.numbers
        : ((g.number === 0 || g.number) ? [g.number] : []);

      const totalbet = Number(
        g.totalbet ?? g.total_bet ?? g.total_bets ?? g.betamount ?? g.bet_amount ?? 0
      );

      const winningnumber =
        (g.winningnumber === 0 || g.winningnumber) ? g.winningnumber
        : ((g.result === 0 || g.result) ? g.result : "-");

      const result = (g.result || "pending");     // pending/win/lose (whatever backend sends)
      const netamount = Number(g.netamount ?? g.amount ?? 0);
      const datetime = g.datetime || g.startedat || g.started_at || "-";

      return {
        roundcode,
        gametype,
        tablenumber: g.tablenumber ?? "-",  // keep column working if backend sends it
        numbers,
        totalbet,
        winningnumber,
        result,
        netamount,
        datetime
      };
    });

    displayUserGames(); // IMPORTANT: render after load [file:131]

    document.getElementById("userGamesLoading").style.display = "none";
    document.getElementById("userGamesTableContainer").style.display = "block";
  } catch (err) {
    document.getElementById("userGamesLoading").innerHTML =
      `<div style="color:#ef4444">Error: ${err.message}</div>`;
  }
}


    displayUserGames();

    document.getElementById("userGamesLoading").style.display = "none";
    document.getElementById("userGamesTableContainer").style.display = "block";
  } catch (err) {
    document.getElementById("userGamesLoading").innerHTML =
      `<div style="color:#ef4444">Error: ${err.message}</div>`;
  }
}

function displayUserGames() {
  const q = safeLower(document.getElementById("searchUserGames")?.value);
  const tbody = document.getElementById("userGamesTableBody");
  tbody.innerHTML = "";

  const filtered = currentUserGames.filter(g =>
    safeLower(g.roundcode).includes(q) || safeLower(g.gametype).includes(q)
  );

  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="7" class="no-data">No games found</td></tr>`;
    return;
  }

  filtered.forEach(g => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><strong>${g.roundcode}</strong></td>
      <td>${g.gametype}</td>
      <td>${g.betNumbers}</td>
      <td>${g.winning}</td>
      <td>${g.status}</td>
      <td>${fmtINR(g.net)}</td>
      <td>${g.datetime}</td>
    `;
    tbody.appendChild(row);
  });
}

    // ------------------------
    // Agents (backend empty currently)
    // ------------------------
    async function loadAgents() {
      document.getElementById('agentsLoading').style.display = 'block';
      document.getElementById('agentsTableContainer').style.display = 'none';

      try {
        const data = await apiGet('/api/admin/agents');
        allAgents = Array.isArray(data) ? data : [];
      } catch (err) {
        allAgents = [];
      }

      displayAgents();
      document.getElementById('agentsLoading').style.display = 'none';
      document.getElementById('agentsTableContainer').style.display = 'block';
    }

    function displayAgents() {
      const tbody = document.getElementById('agentsTableBody');
      tbody.innerHTML = '';

      if (!allAgents.length) {
        tbody.innerHTML = `<tr><td colspan="10" class="no-data">No agents found (Agents backend not implemented yet)</td></tr>`;
        return;
      }

      allAgents.forEach(agent => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${agent.id ?? '-'}</td>
          <td><strong>${agent.name ?? '-'}</strong></td>
          <td>${agent.email ?? '-'}</td>
          <td>${agent.salarypercent ?? 0}</td>
          <td>${agent.usercount ?? 0}</td>
          <td>${fmtINR(agent.totaldeposits ?? 0)}</td>
          <td>${fmtINR(agent.totalwithdrawals ?? 0)}</td>
          <td>${fmtINR(agent.commission ?? 0)}</td>
          <td><span class="badge badge-pending">NA</span></td>
          <td>
            <div class="action-buttons">
              <button class="btn-small btn-edit" onclick="alert('Not implemented yet')">Edit</button>
              <button class="btn-small btn-view" onclick="alert('Not implemented yet')">View</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function submitAddAgent(e) {
      e.preventDefault();
      alert('Agent creation API is not implemented yet in app.py. We will add it next.');
      closeAddAgentModal();
    }

    function openAddAgentModal() { document.getElementById('addAgentModal').classList.add('active'); }
    function closeAddAgentModal() {
      document.getElementById('addAgentModal').classList.remove('active');
      document.getElementById('addAgentForm')?.reset();
    }

    // ------------------------
    // Games
    // ------------------------
    async function loadGames() {
      document.getElementById('gamesLoading').style.display = 'block';
      document.getElementById('gamesTableContainer').style.display = 'none';

      try {
        const data = await apiGet('/api/admin/games');
        allGames = (data || []).map(g => ({
          roundcode: g.roundcode || '-',
          gametype: g.gametype || '-',
          players: Number(g.players || 0),
          maxplayers: Number(g.maxplayers || 0),
          result: (g.result === 0 || g.result) ? g.result : '-',
          totalbets: Number(g.totalbets || 0),
          startedat: g.startedat || g.gamedate || '-',
          status: g.status || (g.isfinished ? 'finished' : (g.isbettingclosed ? 'completed' : 'active'))
        }));

        displayGames();
        document.getElementById('gamesLoading').style.display = 'none';
        document.getElementById('gamesTableContainer').style.display = 'block';
      } catch (err) {
        console.error('Error loading games:', err);
        document.getElementById('gamesLoading').innerHTML = `<div style="color:#ef4444;">Error: ${err.message}</div>`;
      }
    }

    function displayGames() {
      const search = safeLower(document.getElementById('searchGames')?.value);
      const tbody = document.getElementById('gamesTableBody');
      tbody.innerHTML = '';

      const filtered = (allGames || []).filter(g => {
        return safeLower(g.roundcode).includes(search) || safeLower(g.gametype).includes(search);
      });

      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="no-data">No games</td></tr>`;
        return;
      }

      filtered.forEach(game => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${game.roundcode}</strong></td>
          <td>${game.gametype}</td>
          <td>${game.players}/${game.maxplayers}</td>
          <td>${game.result}</td>
          <td>${fmtINR(game.totalbets)}</td>
          <td>${game.startedat}</td>
          <td><span class="badge ${gameStatusBadgeClass(game.status)}">${String(game.status || '-').toUpperCase()}</span></td>
          <td><button class="btn-small btn-view" onclick="viewGameDetails('${String(game.roundcode).replace(/'/g,"\\'")}')">Details</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function viewGameDetails(roundCode) {
      const game = (allGames || []).find(g => g.roundcode === roundCode);
      if (!game) return;

      const html = `
        <div class="details-grid">
          <div class="detail-item"><div class="detail-label">Round Code</div><div class="detail-value">${game.roundcode}</div></div>
          <div class="detail-item"><div class="detail-label">Game Type</div><div class="detail-value">${game.gametype}</div></div>
          <div class="detail-item"><div class="detail-label">Winning Number</div><div class="detail-value" style="color:#f59e0b;">${game.result}</div></div>
          <div class="detail-item"><div class="detail-label">Players</div><div class="detail-value">${game.players}/${game.maxplayers}</div></div>
          <div class="detail-item"><div class="detail-label">Total Bets</div><div class="detail-value">${fmtINR(game.totalbets)}</div></div>
          <div class="detail-item"><div class="detail-label">Date/Time</div><div class="detail-value">${game.startedat}</div></div>
          <div class="detail-item"><div class="detail-label">Status</div><div class="detail-value">${String(game.status || '-').toUpperCase()}</div></div>
        </div>
      `;

      document.getElementById('detailsTitle').textContent = 'Game Details';
      document.getElementById('detailsSubtitle').textContent = '';
      document.getElementById('detailsContent').innerHTML = html;
      document.getElementById('detailsModal').classList.add('active');
    }

    // ------------------------
    // Transactions
    // ------------------------
    async function loadTransactions() {
      document.getElementById('transactionsLoading').style.display = 'block';
      document.getElementById('transactionsTableContainer').style.display = 'none';

      try {
        const data = await apiGet('/api/admin/transactions');

        // Backend does not return txnid; we generate a readable one for UI
        allTxns = (data || []).map((t, idx) => {
          const type = String(t.type || '-').toUpperCase();   // BET / WIN
          const uid = t.userid ?? '-';
          const rc = t.roundcode ?? '-';
          const dt = t.datetime ?? t.txndate ?? '-';
          return {
            txnid: `TX-${type}-${uid}-${String(rc).slice(-8)}-${idx+1}`,
            username: t.username || '-',
            type,
            amount: Number(t.amount || 0),
            status: t.status ? String(t.status).toUpperCase() : (type === 'WIN' ? 'WIN' : 'DONE'),
            datetime: dt,
            reference: t.roundcode || t.reference || '-',
            raw: t
          };
        });

        displayTransactions();
        document.getElementById('transactionsLoading').style.display = 'none';
        document.getElementById('transactionsTableContainer').style.display = 'block';
      } catch (err) {
        console.error('Error loading transactions:', err);
        document.getElementById('transactionsLoading').innerHTML = `<div style="color:#ef4444;">Error: ${err.message}</div>`;
      }
    }

    function displayTransactions() {
      const search = safeLower(document.getElementById('searchTransactions')?.value);
      const tbody = document.getElementById('transactionsTableBody');
      tbody.innerHTML = '';

      const filtered = (allTxns || []).filter(t => {
        return safeLower(t.txnid).includes(search) || safeLower(t.username).includes(search);
      });

      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="no-data">No transactions</td></tr>`;
        return;
      }

      filtered.forEach(txn => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${txn.txnid}</td>
          <td>${txn.username}</td>
          <td><span class="badge ${txnTypeBadgeClass(txn.type)}">${txn.type}</span></td>
          <td>${fmtINR(txn.amount)}</td>
          <td><span class="badge ${txnStatusBadgeClass(txn.status)}">${txn.status}</span></td>
          <td>${txn.datetime || '-'}</td>
          <td>${txn.reference || '-'}</td>
          <td><button class="btn-small btn-view" onclick="viewTxnDetails('${txn.txnid.replace(/'/g,"\\'")}')">View</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function viewTxnDetails(txnid) {
      const txn = (allTxns || []).find(t => t.txnid === txnid);
      if (!txn) return;

      const t = txn.raw || {};
      const html = `
        <div class="details-grid">
          <div class="detail-item"><div class="detail-label">Txn ID</div><div class="detail-value">${txn.txnid}</div></div>
          <div class="detail-item"><div class="detail-label">User</div><div class="detail-value">${txn.username}</div></div>
          <div class="detail-item"><div class="detail-label">Type</div><div class="detail-value">${txn.type}</div></div>
          <div class="detail-item"><div class="detail-label">Amount</div><div class="detail-value">${fmtINR(txn.amount)}</div></div>
          <div class="detail-item"><div class="detail-label">Round Code</div><div class="detail-value">${t.roundcode || '-'}</div></div>
          <div class="detail-item"><div class="detail-label">Game</div><div class="detail-value">${t.gametitle || t.gametype || '-'}</div></div>
          <div class="detail-item"><div class="detail-label">Status</div><div class="detail-value">${txn.status}</div></div>
          <div class="detail-item"><div class="detail-label">Date/Time</div><div class="detail-value">${txn.datetime || '-'}</div></div>
        </div>
      `;

      document.getElementById('detailsTitle').textContent = 'Transaction Details';
      document.getElementById('detailsSubtitle').textContent = '';
      document.getElementById('detailsContent').innerHTML = html;
      document.getElementById('detailsModal').classList.add('active');
    }

    // ------------------------
    // Wallet (uses Users list + working add/deduct API)
    // ------------------------
    async function loadWalletUsers() {
      document.getElementById('walletLoading').style.display = 'block';
      document.getElementById('walletTableContainer').style.display = 'none';

      if (!allUsers.length) {
        await loadUsers();
      }

      allWalletUsers = (allUsers || []).map(u => ({
        id: u.id,
        username: u.username,
        balance: Number(u.balance || 0),
        totaldeposits: 0,
        totalwithdrawals: 0
      }));

      displayWalletUsers();
      document.getElementById('walletLoading').style.display = 'none';
      document.getElementById('walletTableContainer').style.display = 'block';
    }

    function displayWalletUsers() {
      const search = safeLower(document.getElementById('searchWallet')?.value);
      const tbody = document.getElementById('walletTableBody');
      tbody.innerHTML = '';

      const filtered = (allWalletUsers || []).filter(u => safeLower(u.username).includes(search));
      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="no-data">No users</td></tr>`;
        return;
      }

      filtered.forEach(user => {
        const safeU = String(user.username || '').replace(/'/g, "\\'");
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${user.username}</strong></td>
          <td>${fmtINR(user.balance)}</td>
          <td>${fmtINR(user.totaldeposits || 0)}</td>
          <td>${fmtINR(user.totalwithdrawals || 0)}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-small btn-edit" onclick="selectUserForFunds('${safeU}', 'add')">‚ûï Add</button>
              <button class="btn-small btn-block" onclick="selectUserForFunds('${safeU}', 'deduct')">‚ûñ Deduct</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function selectUserForFunds(username, type) {
      if (type === 'add') {
        document.getElementById('addFundsUser').value = username;
        openAddFundsModal();
      } else {
        document.getElementById('deductFundsUser').value = username;
        openDeductFundsModal();
      }
    }

    async function submitAddFunds(e) {
      e.preventDefault();
      const username = (document.getElementById('addFundsUser').value || '').trim();
      const amount = Number(document.getElementById('addFundsAmount').value || 0);
      const reason = document.getElementById('addFundsReason').value || 'Admin add';

      const user = (allUsers || []).find(u => u.username === username);
      if (!user) return alert('User not found: ' + username);
      if (!amount || amount <= 0) return alert('Invalid amount');

      try {
        const res = await apiSend(`/api/admin/users/${user.id}/balance`, 'POST', { type: 'add', amount, reason });
        alert(res.message || 'Done');
        closeAddFundsModal();
        await loadUsers();
        await loadWalletUsers();
        await loadStats();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function submitDeductFunds(e) {
      e.preventDefault();
      const username = (document.getElementById('deductFundsUser').value || '').trim();
      const amount = Number(document.getElementById('deductFundsAmount').value || 0);
      const reason = document.getElementById('deductFundsReason').value || 'Admin deduct';

      const user = (allUsers || []).find(u => u.username === username);
      if (!user) return alert('User not found: ' + username);
      if (!amount || amount <= 0) return alert('Invalid amount');

      try {
        const res = await apiSend(`/api/admin/users/${user.id}/balance`, 'POST', { type: 'deduct', amount, reason });
        alert(res.message || 'Done');
        closeDeductFundsModal();
        await loadUsers();
        await loadWalletUsers();
        await loadStats();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function openAddFundsModal() { document.getElementById('addFundsModal').classList.add('active'); }
    function closeAddFundsModal() {
      document.getElementById('addFundsModal').classList.remove('active');
      document.getElementById('addFundsForm')?.reset();
    }

    function openDeductFundsModal() { document.getElementById('deductFundsModal').classList.add('active'); }
    function closeDeductFundsModal() {
      document.getElementById('deductFundsModal').classList.remove('active');
      document.getElementById('deductFundsForm')?.reset();
    }

    // ------------------------
    // Referrals / Promos / Announcements / Reports (placeholder-safe)
    // ------------------------
    async function loadReferrals() {
      document.getElementById('referralsLoading').style.display = 'block';
      document.getElementById('referralsTableContainer').style.display = 'none';
      const tbody = document.getElementById('referralsTableBody');
      tbody.innerHTML = '';

      try {
        const data = await apiGet('/api/admin/referrals');
        const arr = Array.isArray(data) ? data : [];
        if (!arr.length) tbody.innerHTML = `<tr><td colspan="8" class="no-data">No referral data (not implemented yet)</td></tr>`;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="8" class="no-data">No referral data (not implemented yet)</td></tr>`;
      }

      document.getElementById('referralsLoading').style.display = 'none';
      document.getElementById('referralsTableContainer').style.display = 'block';
    }

    async function loadPromos() {
      document.getElementById('promosLoading').style.display = 'block';
      document.getElementById('promosTableContainer').style.display = 'none';
      const tbody = document.getElementById('promosTableBody');
      tbody.innerHTML = '';

      try {
        const data = await apiGet('/api/admin/promos');
        const arr = Array.isArray(data) ? data : [];
        if (!arr.length) tbody.innerHTML = `<tr><td colspan="8" class="no-data">No promos (placeholder backend)</td></tr>`;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="8" class="no-data">No promos (placeholder backend)</td></tr>`;
      }

      document.getElementById('promosLoading').style.display = 'none';
      document.getElementById('promosTableContainer').style.display = 'block';
    }

    async function submitAddPromo(e) {
      e.preventDefault();
      const data = {
        code: document.getElementById('promoCode').value,
        type: document.getElementById('promoType').value,
        discount: Number(document.getElementById('promoValue').value || 0),
        maxuses: parseInt(document.getElementById('promoMaxUses').value || '0', 10),
        validtill: document.getElementById('promoValidTill').value,
      };

      try {
        const res = await apiSend('/api/admin/promos', 'POST', data);
        alert(res.message || 'Saved');
        closeAddPromoModal();
        loadPromos();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function openAddPromoModal() { document.getElementById('addPromoModal').classList.add('active'); }
    function closeAddPromoModal() {
      document.getElementById('addPromoModal').classList.remove('active');
      document.getElementById('addPromoForm')?.reset();
    }

    async function loadAnnouncements() {
      document.getElementById('announcementsLoading').style.display = 'block';
      document.getElementById('announcementsTableContainer').style.display = 'none';
      const tbody = document.getElementById('announcementsTableBody');
      tbody.innerHTML = '';

      try {
        const data = await apiGet('/api/admin/announcements');
        const arr = Array.isArray(data) ? data : [];
        if (!arr.length) tbody.innerHTML = `<tr><td colspan="6" class="no-data">No announcements (placeholder backend)</td></tr>`;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" class="no-data">No announcements (placeholder backend)</td></tr>`;
      }

      document.getElementById('announcementsLoading').style.display = 'none';
      document.getElementById('announcementsTableContainer').style.display = 'block';
    }

    async function submitAnnounce(e) {
      e.preventDefault();
      const data = {
        title: document.getElementById('announceTitle').value,
        message: document.getElementById('announceMessage').value,
        target: document.getElementById('announceTarget').value,
      };

      try {
        const res = await apiSend('/api/admin/announcements', 'POST', data);
        alert(res.message || 'Sent');
        closeAnnounceModal();
        loadAnnouncements();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function openAnnounceModal() { document.getElementById('announceModal').classList.add('active'); }
    function closeAnnounceModal() {
      document.getElementById('announceModal').classList.remove('active');
      document.getElementById('announceForm')?.reset();
    }

    async function loadReports() {
      try {
        const data = await apiGet('/api/admin/reports');
        document.getElementById('newUsers30d').textContent = data.totalusers ?? 0;
        document.getElementById('revenue30d').textContent = fmtINR(data.totalbalance ?? 0);
        document.getElementById('gamesPlayed30d').textContent = 0;
        document.getElementById('avgWinRate').textContent = '0%';
      } catch (err) {
        console.error('Reports error:', err);
      }
    }

    function openSecurityModal() {
      alert('Security module will be added next.');
    }

    function closeDetailsModal() {
      document.getElementById('detailsModal').classList.remove('active');
    }
  </script>
</body>
</html>
