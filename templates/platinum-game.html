<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Parachute Drop - BetGames</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; font-family: 'Segoe UI'; background: #1a1a2e; color: #fff; overflow: hidden; }
        body { display: flex; flex-direction: column; }
        .game-container { flex: 1; display: flex; flex-direction: column; background: linear-gradient(180deg, #1e90ff 0%, #20b2aa 50%, #87ceeb 100%); overflow: hidden; }
        .header-bar { background: rgba(15, 52, 96, 0.9); padding: 10px 15px; display: flex; justify-content: space-between; border-bottom: 2px solid #e5e4e2; }
        .game-title { font-size: 18px; font-weight: 700; color: #e5e4e2; }
        .timer-display { background: linear-gradient(135deg, #e5e4e2, #f5f5f5); color: #000; padding: 6px 15px; border-radius: 20px; font-weight: 700; }
        .timer-display.warning { background: linear-gradient(135deg, #ff6b6b, #ff5252); color: #fff; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .balance-info { background: rgba(229, 228, 226, 0.2); padding: 6px 12px; border-radius: 8px; font-size: 12px; color: #e5e4e2; }
        .game-area { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; }
        .sky { width: 100%; height: 60%; position: relative; display: flex; align-items: center; justify-content: center; }
        .parachuter { font-size: 60px; position: absolute; top: 0; left: 50%; transform: translateX(-50%); animation: fall 3s ease-in; z-index: 20; }
        .parachuter.landing { animation: land 1s ease-out forwards; }
        @keyframes fall { 0% { top: 0; } 100% { top: 100%; } }
        @keyframes land { 0% { top: var(--start-top); } 100% { top: 60%; } }
        .parachute { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 40px; animation: drift 3s ease-in-out; }
        @keyframes drift { 0% { left: 50%; top: 0; } 50% { left: 45%; } 100% { left: 50%; top: 100%; } }
        .river { width: 100%; height: 40%; background: linear-gradient(180deg, #20b2aa 0%, #008b8b 100%); position: relative; display: flex; align-items: center; justify-content: space-around; padding: 20px; }
        .boats { display: flex; justify-content: space-around; width: 100%; align-items: flex-end; gap: 10px; padding: 0 20px; }
        .boat { width: 70px; height: 50px; background: linear-gradient(135deg, #ff6b35, #f7931e); border-radius: 10px 10px 50% 50%; border: 3px solid #d64045; cursor: pointer; transition: all 0.3s; display: flex; align-items: flex-start; justify-content: center; font-weight: 700; color: #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden; }
        .boat::before { content: ''; position: absolute; top: 5px; width: 100%; height: 2px; background: rgba(255, 255, 255, 0.3); }
        .boat:hover { transform: scale(1.1) translateY(-5px); box-shadow: 0 6px 20px rgba(229, 228, 226, 0.5); }
        .boat.selected { background: linear-gradient(135deg, #00ff00, #00cc00); border-color: #00ff00; box-shadow: 0 0 25px rgba(0, 255, 0, 0.7); }
        .boat-number { font-size: 20px; margin-top: 5px; }
        .betting-panel { background: rgba(15, 52, 96, 0.95); padding: 15px; border-top: 2px solid #e5e4e2; min-height: 60px; }
        .status-text { font-size: 12px; color: #aaa; margin-bottom: 8px; }
        .your-bets { display: flex; gap: 8px; flex-wrap: wrap; }
        .bet-badge { background: #e5e4e2; color: #000; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 700; }
        .message-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #e5e4e2, #f5f5f5); color: #000; padding: 30px 40px; border-radius: 15px; font-size: 18px; font-weight: 700; z-index: 100; display: none; text-align: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); }
        .message-box.show { display: block; animation: message-pop 0.3s ease-out; }
        .message-box.error { background: linear-gradient(135deg, #ff6b6b, #ff5252); color: #fff; }
        @keyframes message-pop { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .back-button { position: fixed; top: 10px; left: 10px; background: rgba(229, 228, 226, 0.3); border: 1px solid #e5e4e2; color: #e5e4e2; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; z-index: 50; }
        .back-button:hover { background: #e5e4e2; color: #000; }
    </style>
</head>
<body>
    <button class="back-button" onclick="goBack()">‚Üê Back</button>
    <div class="game-container">
        <div class="header-bar">
            <div class="game-title">ü™Ç Parachute Drop</div>
            <div class="timer-display" id="timer">5:00</div>
            <div class="balance-info">üí∞ <span id="balance">200000</span></div>
        </div>
        <div class="game-area">
            <div class="sky" id="sky">
                <div class="parachute" id="parachute">‚òÇÔ∏è</div>
                <div class="parachuter" id="parachuter">ü™Ç</div>
            </div>
            <div class="river">
                <div class="boats" id="boatsContainer"></div>
            </div>
        </div>
        <div class="betting-panel">
            <div class="status-text" id="statusText">Click boats to predict the landing spot!</div>
            <div class="your-bets">
                <span style="font-size: 12px; color: #e5e4e2; font-weight: 600;">Your Bets:</span>
                <div id="myBets"></div>
            </div>
        </div>
    </div>
    <div class="message-box" id="messageBox"></div>

    <script>
        let userId = localStorage.getItem('userId'), username = localStorage.getItem('username'), gameType = 'platinum';
        let mySelectedNumbers = [], socket = io();
        fetch('/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: userId, username: username}) });
        
        function createBoats() {
            const c = document.getElementById('boatsContainer');
            c.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const b = document.createElement('div');
                b.className = 'boat';
                b.innerHTML = `<div class="boat-number">${i}</div>`;
                b.id = `boat-${i}`;
                c.appendChild(b);
            }
        }
        createBoats();
        socket.emit('join_game', {game_type: gameType, user_id: userId});
        socket.on('timer_update', data => {
            if (data.game_type === gameType) {
                const time = data.betting_time_remaining || data.time_remaining;
                const mins = Math.floor(time / 60);
                const secs = time % 60;
                document.getElementById('timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                if (time <= 15 && time > 0) document.getElementById('timer').classList.add('warning');
                else document.getElementById('timer').classList.remove('warning');
            }
        });
        socket.on('round_result', data => {
            if (data.game_type === gameType) dropParachute(data.result, data.winners);
        });
        socket.on('bet_placed', () => { mySelectedNumbers.forEach(n => document.getElementById(`boat-${n}`).classList.add('selected')); });
        socket.on('bet_success', () => { fetch(`/balance/${userId}`).then(r => r.json()).then(d => { document.getElementById('balance').textContent = d.balance; }); });
        socket.on('bet_error', data => { showMessage(data.message, true); });
        socket.on('new_round', () => { mySelectedNumbers = []; updateMyBets(); });

        function placeBet(number) {
            if (mySelectedNumbers.includes(number)) { showMessage('Already bet on this boat', true); return; }
            if (mySelectedNumbers.length >= 4) { showMessage('Maximum 4 bets per game', true); return; }
            socket.emit('place_bet', {game_type: gameType, user_id: userId, username: username, number: number});
            mySelectedNumbers.push(number);
            updateMyBets();
        }
        function updateMyBets() { const d = document.getElementById('myBets'); d.innerHTML = mySelectedNumbers.length === 0 ? '<span style="color: #aaa; font-size: 12px;">No bets yet</span>' : mySelectedNumbers.map(n => `<div class="bet-badge">Boat ${n}</div>`).join(''); }
        function dropParachute(num, winners) { 
            setTimeout(() => {
                const para = document.getElementById('parachuter');
                const boat = document.getElementById(`boat-${num}`);
                const sky = document.getElementById('sky');
                const skyRect = sky.getBoundingClientRect();
                const boatRect = boat.getBoundingClientRect();
                const offset = boatRect.left - skyRect.left + boatRect.width / 2;
                para.style.setProperty('--start-top', '0px');
                para.style.left = offset + 'px';
                para.classList.add('landing');
                setTimeout(() => {
                    boat.style.background = 'linear-gradient(135deg, #90EE90, #00ff00)';
                    boat.style.borderColor = '#00ff00';
                    boat.style.boxShadow = '0 0 30px rgba(0, 255, 0, 1), 0 4px 8px rgba(0, 0, 0, 0.3)';
                    boat.style.animation = 'rock 0.4s ease-in-out 2';
                    showMessage(winners.some(w => w.user_id === userId) ? `üéâ LANDED! +${winners.find(w => w.user_id === userId).payout} coins!` : '‚ùå Missed the boat', !winners.some(w => w.user_id === userId));
                }, 1000);
            }, 500);
        }
        function showMessage(text, isError = false) { const m = document.getElementById('messageBox'); m.textContent = text; m.classList.toggle('error', isError); m.classList.add('show'); setTimeout(() => { m.classList.remove('show'); }, 2500); }
        document.addEventListener('click', (e) => { if (e.target.closest('.boat')) placeBet(parseInt(e.target.closest('.boat').id.split('-')[1])); });
        function goBack() { window.location.href = '/'; }
        setInterval(() => { fetch(`/balance/${userId}`).then(r => r.json()).then(d => { document.getElementById('balance').textContent = d.balance; }); }, 2000);
    </script>
</body>
</html>
