<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Panel - Game of Five</title>

  <!-- Same theme as admin_panel.html (copied + cleaned; no HTML inside <style>) -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }

    .admin-wrapper { display: flex; height: 100vh; width: 100%; }

    /* SIDEBAR */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      border-right: 2px solid #334155;
      padding: 25px 0;
      overflow-y: auto;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 100;
    }

    .sidebar-header {
      padding: 0 20px 30px 20px;
      border-bottom: 2px solid #334155;
      margin-bottom: 20px;
    }

    .sidebar-header h1 {
      font-size: 24px;
      font-weight: bold;
      color: #10b981;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
    }

    .sidebar-menu { list-style: none; padding: 0; margin: 0; }
    .sidebar-menu li { margin: 0; padding: 0; }

    .sidebar-menu a {
      display: block;
      padding: 15px 25px;
      color: #cbd5e1;
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
    }

    .sidebar-menu a:hover {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border-left-color: #10b981;
      padding-left: 28px;
    }

    .sidebar-menu a.active {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border-left-color: #10b981;
      font-weight: 600;
    }

    .menu-divider { height: 1px; background: #334155; margin: 15px 0; }

    /* MAIN CONTENT */
    .main-content {
      margin-left: 280px;
      flex: 1;
      display: flex;
      flex-direction: column;
      width: calc(100% - 280px);
      height: 100vh;
      overflow: hidden;
    }

    .top-header {
      background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%);
      border-bottom: 2px solid #334155;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .top-header h1 { font-size: 32px; font-weight: bold; color: #e2e8f0; margin: 0; }

    .logout-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(239,68,68,0.3);
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239,68,68,0.4);
    }

    /* CONTENT */
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 40px;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }

    .section { display: none; animation: fadeIn 0.3s ease-in; }
    .section.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* DASHBOARD */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: 2px solid #334155;
      border-radius: 12px;
      padding: 30px;
      transition: all 0.3s ease;
      cursor: default;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, #10b981, #06b6d4);
    }

    .stat-card:hover {
      border-color: #10b981;
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(16,185,129,0.2);
    }

    .stat-label {
      color: #94a3b8;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .stat-value { color: #10b981; font-size: 42px; font-weight: bold; margin: 0; }
    .stat-icon { position: absolute; right: 20px; top: 20px; font-size: 32px; opacity: 0.2; }

    /* SECTION */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .section-title { font-size: 28px; font-weight: bold; color: #e2e8f0; margin: 0; }

    .controls { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }

    .search-box { display: flex; gap: 12px; flex: 1; min-width: 300px; }

    .search-box input {
      flex: 1;
      padding: 12px 16px;
      background: #1e293b;
      border: 2px solid #334155;
      color: #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
    }

    .search-box button, .btn-primary {
      padding: 12px 24px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .search-box button:hover, .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16,185,129,0.3);
    }

    /* TABLE */
    .table-container {
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }

    .data-table thead {
      background: linear-gradient(90deg, #0f172a 0%, #1e293b 100%);
      border-bottom: 2px solid #334155;
    }

    .data-table th {
      padding: 18px 20px;
      text-align: left;
      color: #94a3b8;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
      white-space: nowrap;
    }

    .data-table td {
      padding: 16px 20px;
      border-bottom: 1px solid #334155;
      color: #cbd5e1;
      vertical-align: middle;
    }

    .data-table tbody tr:hover { background: rgba(16,185,129,0.05); }

    /* BADGES */
    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
      white-space: nowrap;
    }

    .badge-active {
      background: rgba(16,185,129,0.2);
      color: #10b981;
      border: 1px solid rgba(16,185,129,0.3);
    }

    .badge-blocked {
      background: rgba(239,68,68,0.2);
      color: #ef4444;
      border: 1px solid rgba(239,68,68,0.3);
    }

    .badge-pending {
      background: rgba(245,158,11,0.2);
      color: #f59e0b;
      border: 1px solid rgba(245,158,11,0.3);
    }

    /* STATES */
    .loading { text-align: center; padding: 60px 20px; color: #94a3b8; font-size: 16px; }
    .no-data { text-align: center; padding: 60px 20px; color: #64748b; font-size: 15px; }

    /* FORMS */
    .form-card {
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      color: #94a3b8;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 16px;
      background: #0f172a;
      border: 2px solid #334155;
      color: #e2e8f0;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
    }

    .muted {
      color: #94a3b8;
      font-size: 13px;
      line-height: 1.4;
    }

    /* DETAILS GRID (for profile) */
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
    .detail-item { background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #334155; }
    .detail-label { color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; font-weight: 600; }
    .detail-value { color: #10b981; font-size: 18px; font-weight: bold; }

    /* MODAL (optional, for premium errors) */
    .modal {
      display: none !important;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    }
    .modal.active { display: flex !important; }

    .modal-content {
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 12px;
      padding: 28px;
      width: 92%;
      max-width: 650px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      margin: 20px auto;
    }
    .modal-header { margin-bottom: 14px; }
    .modal-header h2 { color: #e2e8f0; font-size: 22px; margin: 0; font-weight: bold; }
    .modal-header p { color: #94a3b8; margin: 8px 0 0 0; }

    .modal-footer { display: flex; gap: 12px; margin-top: 18px; }
    .btn-modal {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-cancel { background: #334155; color: #cbd5e1; }
    .btn-cancel:hover { background: #475569; }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .sidebar { width: 260px; }
      .main-content { width: calc(100% - 260px); margin-left: 260px; }
      .form-row { grid-template-columns: 1fr; }
      .details-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .admin-wrapper { flex-direction: column; }
      .sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 2px solid #334155;
        position: relative;
      }
      .main-content { width: 100%; margin-left: 0; }
      .content-area { padding: 18px; }
    }
  </style>
</head>

<body>
  <div class="admin-wrapper">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>üë®‚Äçüíº Agent Panel</h1>
      </div>

      <ul class="sidebar-menu">
        <li><a class="menu-link active" data-section="dashboard">üìä Dashboard</a></li>
        <li><a class="menu-link" data-section="users">üë• Users</a></li>
        <li><a class="menu-link" data-section="salary">üí∏ Salary</a></li>
        <li><a class="menu-link" data-section="profile">üßæ Profile</a></li>

        <li><div class="menu-divider"></div></li>
        <li><a class="menu-link" onclick="logout()" style="color:#ef4444;">üö™ Logout</a></li>
      </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="top-header">
        <h1 id="pageTitle">Dashboard</h1>
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
      </div>

      <div class="content-area">
        <!-- DASHBOARD -->
        <div id="dashboard" class="section active">
          <div class="dashboard-grid">
            <div class="stat-card">
              <div class="stat-icon">üë•</div>
              <div class="stat-label">Total Users</div>
              <p class="stat-value" id="totalUsers">0</p>
            </div>

            <div class="stat-card">
              <div class="stat-icon">üí∏</div>
              <div class="stat-label">Total Salary</div>
              <p class="stat-value" id="totalSalary">‚Çπ0</p>
            </div>
          </div>

          <div class="section-header">
            <h2 class="section-title">Add User</h2>
            <button class="btn-primary" onclick="refreshDashboard()">‚ü≥ Refresh</button>
          </div>

          <div class="form-card">
            <div class="muted" style="margin-bottom:14px;">
              Create new player under your agent account. New user starts with 0 coins.
            </div>

            <form id="addUserForm">
              <div class="form-row">
                <div class="form-group">
                  <label>Username</label>
                  <input type="text" id="newUsername" placeholder="username" required />
                </div>
                <div class="form-group">
                  <label>Password</label>
                  <input type="password" id="newPassword" placeholder="password" required />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Display Name (optional)</label>
                  <input type="text" id="newDisplayName" placeholder="Player name" />
                </div>
                <div class="form-group">
                  <label>Phone (optional)</label>
                  <input type="text" id="newPhone" placeholder="9999999999" />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Email (optional)</label>
                  <input type="email" id="newEmail" placeholder="player@example.com" />
                </div>
                <div class="form-group">
                  <label>Country (optional)</label>
                  <input type="text" id="newCountry" placeholder="India" />
                </div>
              </div>

              <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:10px;">
                <button type="submit" class="btn-primary">‚ûï Create User</button>
                <button type="button" class="btn-primary" onclick="switchSection('users'); loadUsers();">üë• Go to Users</button>
              </div>
            </form>
          </div>
        </div>

        <!-- USERS -->
        <div id="users" class="section">
          <div class="section-header">
            <h2 class="section-title">Users</h2>
            <button class="btn-primary" onclick="loadUsers()">‚ü≥ Reload</button>
          </div>

          <div class="controls">
            <div class="search-box">
              <input type="text" id="searchUsers" placeholder="Search by username or user id..." />
              <button onclick="displayUsers()">üîç Search</button>
            </div>
          </div>

          <div id="usersLoading" class="loading">Loading users...</div>

          <div id="usersTableContainer" style="display:none;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>S.No.</th>
                    <th>User</th>
                    <th>Status</th>
                    <th>Amount Played</th>
                    <th>Salary Generated</th>
                    <th>Joining</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SALARY -->
        <div id="salary" class="section">
          <div class="section-header">
            <h2 class="section-title">Salary</h2>
            <button class="btn-primary" onclick="loadSalary()">Apply</button>
          </div>

          <div class="controls">
            <div class="search-box" style="min-width: 320px;">
              <input type="date" id="salaryFrom" />
              <input type="date" id="salaryTo" />
            </div>
            <button class="btn-primary" onclick="setThisMonth()">This Month</button>
            <button class="btn-primary" onclick="setToday()">Today</button>
          </div>

          <div class="dashboard-grid">
            <div class="stat-card">
              <div class="stat-icon">üéÆ</div>
              <div class="stat-label">Total Played (range)</div>
              <p class="stat-value" id="rangePlayed">‚Çπ0</p>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üí∏</div>
              <div class="stat-label">Total Salary (range)</div>
              <p class="stat-value" id="rangeSalary">‚Çπ0</p>
            </div>
          </div>

          <div id="salaryLoading" class="loading" style="display:none;">Loading salary...</div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>S.No.</th>
                  <th>User ID</th>
                  <th>Joining</th>
                  <th>Amount Played</th>
                  <th>Salary Generated</th>
                </tr>
              </thead>
              <tbody id="salaryTableBody">
                <tr><td colspan="5" class="no-data">Select date range and click Apply.</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- PROFILE -->
        <div id="profile" class="section">
          <div class="section-header">
            <h2 class="section-title">Profile</h2>
            <button class="btn-primary" onclick="loadProfile()">‚ü≥ Refresh</button>
          </div>

          <div class="form-card">
            <div class="details-grid">
              <div class="detail-item">
                <div class="detail-label">Agent Name</div>
                <div class="detail-value" id="agentName">-</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Username</div>
                <div class="detail-value" id="agentUsername">-</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Salary %</div>
                <div class="detail-value" id="agentSalaryPercent">-</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Status</div>
                <div class="detail-value" id="agentStatus">-</div>
              </div>
            </div>

            <div style="height:1px; background:#334155; margin:18px 0;"></div>

            <h3 style="margin:0 0 12px 0; font-size:18px; color:#e2e8f0;">Change Password</h3>

            <form id="changePasswordForm">
              <div class="form-row">
                <div class="form-group">
                  <label>New Password</label>
                  <input type="password" id="pw1" required />
                </div>
                <div class="form-group">
                  <label>Confirm Password</label>
                  <input type="password" id="pw2" required />
                </div>
              </div>
              <button type="submit" class="btn-primary">üîê Update Password</button>
              <div class="muted" style="margin-top:10px;">Tip: Use a strong password for premium security.</div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Simple modal for premium errors/messages -->
  <div id="msgModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="msgTitle">Message</h2>
        <p id="msgText" style="color:#94a3b8; margin-top:8px;"></p>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-cancel" onclick="closeMsgModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ------------------------
    // State
    // ------------------------
    let agentUsers = [];

    // ------------------------
    // Helpers (same style as admin_panel.html)
    // ------------------------
    async function apiGet(url) {
      const r = await fetch(url, { credentials: 'same-origin' });
      const ct = r.headers.get('content-type') || '';
      let data = null;

      if (ct.includes('application/json')) data = await r.json().catch(() => null);
      else data = await r.text().catch(() => '');

      if (!r.ok) {
        const msg = (data && data.message) ? data.message : (typeof data === 'string' ? data : `HTTP ${r.status}`);
        throw new Error(`${url} -> ${msg}`);
      }
      return data;
    }

    async function apiSend(url, method, bodyObj) {
      const r = await fetch(url, {
        method,
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: bodyObj ? JSON.stringify(bodyObj) : undefined
      });

      const ct = r.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await r.json().catch(() => ({})) : await r.text().catch(() => '');
      if (!r.ok) throw new Error((data && data.message) ? data.message : `HTTP ${r.status}`);
      return data;
    }

    function fmtINR(n) {
      const v = Number(n || 0);
      return '‚Çπ' + v.toLocaleString('en-IN');
    }

    function safeLower(x) {
      return String(x || '').toLowerCase();
    }

    function statusBadgeClass(status) {
      const s = safeLower(status);
      return (s === 'blocked') ? 'badge-blocked' : 'badge-active';
    }

    function showMsg(title, text) {
      document.getElementById('msgTitle').textContent = title || 'Message';
      document.getElementById('msgText').textContent = text || '';
      document.getElementById('msgModal').classList.add('active');
    }

    function closeMsgModal() {
      document.getElementById('msgModal').classList.remove('active');
    }

    function logout() {
      // If your agent logout URL is different, change it here
      window.location.href = '/agent/logout';
    }

    // ------------------------
    // Menu (same behavior as admin_panel.html)
    // ------------------------
    document.addEventListener('DOMContentLoaded', function () {
      setupMenuLinks();
      wireForms();

      // initial
      refreshDashboard();
    });

    function setupMenuLinks() {
      document.querySelectorAll('.menu-link').forEach((link) => {
        link.addEventListener('click', function (e) {
          if (this.getAttribute('onclick')) return;
          e.preventDefault();
          const section = this.dataset.section;
          switchSection(section);
          document.querySelectorAll('.menu-link').forEach((l) => l.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }

    function switchSection(section) {
      document.querySelectorAll('.section').forEach((s) => s.classList.remove('active'));
      const el = document.getElementById(section);
      if (el) el.classList.add('active');

      const titles = {
        dashboard: 'Dashboard',
        users: 'Users',
        salary: 'Salary',
        profile: 'Profile',
      };
      document.getElementById('pageTitle').textContent = titles[section] || 'Agent Panel';

      if (section === 'dashboard') refreshDashboard();
      if (section === 'users') loadUsers();
      if (section === 'salary') loadSalary();
      if (section === 'profile') loadProfile();
    }

    function wireForms() {
      document.getElementById('addUserForm')?.addEventListener('submit', submitAddUser);
      document.getElementById('changePasswordForm')?.addEventListener('submit', submitChangePassword);
      document.getElementById('searchUsers')?.addEventListener('keyup', displayUsers);
    }

    // ------------------------
    // Dashboard
    // ------------------------
    async function refreshDashboard() {
      try {
        const data = await apiGet('/api/agent/stats');
        document.getElementById('totalUsers').textContent = data.totalusers ?? 0;
        document.getElementById('totalSalary').textContent = fmtINR(data.totalsalary ?? 0);
      } catch (err) {
        showMsg('Dashboard Error', err.message);
      }
    }

    async function submitAddUser(e) {
      e.preventDefault();
      const payload = {
        username: (document.getElementById('newUsername').value || '').trim(),
        password: (document.getElementById('newPassword').value || '').trim(),
        displayname: (document.getElementById('newDisplayName').value || '').trim(),
        phone: (document.getElementById('newPhone').value || '').trim(),
        email: (document.getElementById('newEmail').value || '').trim(),
        country: (document.getElementById('newCountry').value || '').trim(),
      };

      if (!payload.username || !payload.password) {
        showMsg('Validation', 'Username and Password are required.');
        return;
      }

      try {
        const res = await apiSend('/api/agent/users', 'POST', payload);
        showMsg('User Created', res.message || 'User created successfully.');
        document.getElementById('addUserForm')?.reset();
        await refreshDashboard();
      } catch (err) {
        showMsg('Add User Error', err.message);
      }
    }

    // ------------------------
    // Users
    // ------------------------
    async function loadUsers() {
      document.getElementById('usersLoading').style.display = 'block';
      document.getElementById('usersTableContainer').style.display = 'none';

      try {
        const data = await apiGet('/api/agent/users');
        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
        agentUsers = items.map(u => ({
          userid: u.userid ?? u.id ?? '',
          username: u.username ?? ('#' + (u.userid ?? u.id ?? '')),
          status: u.status ?? 'active',
          joining: u.joining ?? u.createdat ?? '-',
          amountplayed: Number(u.amountplayed ?? 0),
          salarygenerated: Number(u.salarygenerated ?? 0),
        }));

        displayUsers();

        document.getElementById('usersLoading').style.display = 'none';
        document.getElementById('usersTableContainer').style.display = 'block';
      } catch (err) {
        document.getElementById('usersLoading').innerHTML = `<div style="color:#ef4444;">Error: ${err.message}</div>`;
      }
    }

    function displayUsers() {
      const q = safeLower(document.getElementById('searchUsers')?.value);
      const filtered = (agentUsers || []).filter(u =>
        safeLower(u.username).includes(q) ||
        safeLower(u.userid).includes(q)
      );

      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';

      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="no-data">No users found</td></tr>`;
        return;
      }

      filtered.forEach((u, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${idx + 1}</td>
          <td><strong>${u.username}</strong><div class="muted" style="margin-top:4px;">User ID: ${u.userid}</div></td>
          <td><span class="badge ${statusBadgeClass(u.status)}">${String(u.status || 'active').toUpperCase()}</span></td>
          <td>${fmtINR(u.amountplayed)}</td>
          <td>${fmtINR(u.salarygenerated)}</td>
          <td>${u.joining || '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // ------------------------
    // Salary
    // ------------------------
    function setToday() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const s = `${y}-${m}-${day}`;
      document.getElementById('salaryFrom').value = s;
      document.getElementById('salaryTo').value = s;
      loadSalary();
    }

    function setThisMonth() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const from = `${y}-${m}-01`;
      const to = `${y}-${m}-${String(new Date(y, d.getMonth() + 1, 0).getDate()).padStart(2, '0')}`;
      document.getElementById('salaryFrom').value = from;
      document.getElementById('salaryTo').value = to;
      loadSalary();
    }

    async function loadSalary() {
      const from = document.getElementById('salaryFrom').value;
      const to = document.getElementById('salaryTo').value;

      document.getElementById('salaryLoading').style.display = 'block';

      try {
        const qs = new URLSearchParams();
        if (from) qs.set('from', from);
        if (to) qs.set('to', to);

        const data = await apiGet('/api/agent/salary?' + qs.toString());

        document.getElementById('rangePlayed').textContent = fmtINR(data.totalplayed ?? 0);
        document.getElementById('rangeSalary').textContent = fmtINR(data.totalsalary ?? 0);

        const items = Array.isArray(data?.items) ? data.items : [];
        const tbody = document.getElementById('salaryTableBody');
        tbody.innerHTML = '';

        if (!items.length) {
          tbody.innerHTML = `<tr><td colspan="5" class="no-data">No data for selected range.</td></tr>`;
          return;
        }

        items.forEach((u, idx) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${idx + 1}</td>
            <td>${u.userid ?? '-'}</td>
            <td>${u.joining ?? '-'}</td>
            <td>${fmtINR(Number(u.amountplayed ?? 0))}</td>
            <td>${fmtINR(Number(u.salarygenerated ?? 0))}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        showMsg('Salary Error', err.message);
      } finally {
        document.getElementById('salaryLoading').style.display = 'none';
      }
    }

    // ------------------------
    // Profile
    // ------------------------
    async function loadProfile() {
      try {
        const data = await apiGet('/api/agent/profile');
        document.getElementById('agentName').textContent = data.name ?? '-';
        document.getElementById('agentUsername').textContent = data.username ?? '-';
        document.getElementById('agentSalaryPercent').textContent = (data.salarypercent ?? 0) + '%';
        document.getElementById('agentStatus').textContent = (data.status ?? 'ACTIVE').toString().toUpperCase();
      } catch (err) {
        showMsg('Profile Error', err.message);
      }
    }

    async function submitChangePassword(e) {
      e.preventDefault();
      const p1 = (document.getElementById('pw1').value || '').trim();
      const p2 = (document.getElementById('pw2').value || '').trim();

      if (!p1 || p1.length < 4) return showMsg('Validation', 'Password must be at least 4 characters.');
      if (p1 !== p2) return showMsg('Validation', 'Passwords do not match.');

      try {
        const res = await apiSend('/api/agent/profile/password', 'PUT', { password: p1 });
        showMsg('Password Updated', res.message || 'Password updated successfully.');
        document.getElementById('changePasswordForm')?.reset();
      } catch (err) {
        showMsg('Password Error', err.message);
      }
    }
  </script>
</body>
</html>
